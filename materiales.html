<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Materiales Registrados</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      min-height: 100vh;
      background-color: #f4f6f9;
    }

    .sidebar {
      width: 230px;
      background-color: #5a7f71;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
    }
    .sidebar h2 { text-align:center; font-size:22px; margin-bottom:18px;}
    .sidebar a {
      color: white; text-decoration: none; padding: 12px 20px; display:block;
      transition: background-color 0.2s; font-size: 16px;
    }
    .sidebar a:hover, .sidebar a.active { background-color: #4a6a5f; border-left:4px solid #fff; }

    .content {
      margin-left: 230px;
      padding: 30px;
      width: calc(100% - 230px);
    }

    .titulo-rectangulo {
      background-color: #5a7f71;
      color: white;
      padding: 15px 22px;
      border-radius: 10px;
      font-size: 28px;
      font-weight: bold;
      width: 100%;
      display: block;
      margin-bottom: 25px;
      text-align: center;
    }

    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 20px;
    }

    table thead { background-color: #e7edff; }
    table th, table td { text-align:center; vertical-align:middle; }
    .btn-custom { background-color: #5a7f71; color: white; border: none; padding:6px 10px; border-radius:6px; }
    .btn-edit { background-color:#2563eb; color:white; border:none; padding:5px 10px; border-radius:6px; }
    .btn-del { background-color:#e11d48; color:white; border:none; padding:5px 10px; border-radius:6px; }

    .search-bar {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search-bar input { flex: 1; }

  </style>
</head>

<body>
  <div class="sidebar">
    <h2>Gestor de Obra</h2>
    <a href="materiales.html" class="active">üìã Materiales</a>
    <a href="materiales_generales.html">‚ûï Agregar material</a>
    <a href="cotizacion.html">üí∞ Hacer cotizaci√≥n</a>
    <a href="registro.html">üìù Registro</a>
    <a href="estadisticas.html">üìä Estad√≠sticas</a>
    <a href="facturacion.html">üßæ Facturaci√≥n</a>
    <a href="proyectos.html">üèóÔ∏è Proyectos</a>
    <a href="clientes.html">üë• Clientes y Proveedores</a>
  </div>

  <div class="content">
    <div class="titulo-rectangulo">Materiales Registrados</div>

    <div class="card">
      <div class="search-bar">
        <input type="text" id="searchInput" class="form-control" placeholder="Buscar por ID o Unidad...">
        <button id="clearSearch" class="btn btn-secondary">Limpiar</button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Unidad</th>
              <th>Precio</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <tbody id="tablaMateriales">
            <tr><td colspan="5">Cargando materiales...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const BASE = 'http://localhost:3000';
  let materialesData = [];

  function getField(m, ...keys) {
    for (const k of keys) if (m[k] !== undefined && m[k] !== null) return m[k];
    return '';
  }

  function formatPrice(v) {
    const n = parseFloat(v);
    return isNaN(n) ? v : '$' + n.toFixed(2);
  }

  async function cargarMateriales() {
    const tbody = document.getElementById('tablaMateriales');
    try {
      const res = await fetch(`${BASE}/cotizador`);
      if (!res.ok) throw new Error();

      const data = await res.json();
      materialesData = data;
      renderMateriales(data);

    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="5">Error al cargar materiales.</td></tr>`;
    }
  }

  function renderMateriales(data) {
    const tbody = document.getElementById('tablaMateriales');

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="5">No hay materiales registrados.</td></tr>`;
      return;
    }

    tbody.innerHTML = '';

    data.forEach(m => {
      const id = getField(m, 'IDmaterial','id','ID','Id');
      const nombre = getField(m, 'Nombre','nombre');
      const unidad = getField(m, 'Unidad','unidad');
      const precioRaw = getField(m, 'Precio','precio');

      const tr = document.createElement('tr');
      tr.dataset.id = id;

      tr.innerHTML = `
        <td>${id}</td>
        <td class="td-nombre">${nombre}</td>
        <td class="td-unidad">${unidad}</td>
        <td class="td-precio">${formatPrice(precioRaw)}</td>
        <td>
          <button class="btn-edit" data-action="editar">Editar</button>
          <button class="btn-custom" data-action="guardar" style="display:none">Guardar</button>
          <button class="btn-custom" data-action="cancelar" style="display:none">Cancelar</button>
        </td>
      `;

      tbody.appendChild(tr);

      tr.querySelector('[data-action="editar"]').onclick = () => iniciarEdicion(tr);
      tr.querySelector('[data-action="guardar"]').onclick = () => guardarEdicion(tr);
      tr.querySelector('[data-action="cancelar"]').onclick = () => cancelarEdicion(tr, { nombre, unidad, precioRaw });
    });
  }

  function iniciarEdicion(tr) {
    const nombre = tr.querySelector('.td-nombre').textContent.trim();
    const unidad = tr.querySelector('.td-unidad').textContent.trim();
    const precio = tr.querySelector('.td-precio').textContent.replace('$','').trim();

    tr.querySelector('.td-nombre').innerHTML = `<input class="form-control input-nombre" value="${nombre}">`;
    tr.querySelector('.td-unidad').innerHTML = `<input class="form-control input-unidad" value="${unidad}">`;
    tr.querySelector('.td-precio').innerHTML = `<input type="number" step="0.01" class="form-control input-precio" value="${precio}">`;

    tr.querySelector('[data-action="editar"]').style.display = 'none';
    tr.querySelector('[data-action="guardar"]').style.display = 'inline-block';
    tr.querySelector('[data-action="cancelar"]').style.display = 'inline-block';
  }

  function cancelarEdicion(tr, original) {
    tr.querySelector('.td-nombre').textContent = original.nombre;
    tr.querySelector('.td-unidad').textContent = original.unidad;
    tr.querySelector('.td-precio').textContent = formatPrice(original.precioRaw);

    tr.querySelector('[data-action="editar"]').style.display = 'inline-block';
    tr.querySelector('[data-action="guardar"]').style.display = 'none';
    tr.querySelector('[data-action="cancelar"]').style.display = 'none';
  }

  async function guardarEdicion(tr) {
    const id = tr.dataset.id;

    const nombre = tr.querySelector('.input-nombre').value.trim();
    const unidad = tr.querySelector('.input-unidad').value.trim();
    const precio = parseFloat(tr.querySelector('.input-precio').value);

    if (!nombre) return alert("El nombre no puede ir vac√≠o");
    if (!unidad) return alert("La unidad no puede ir vac√≠a");
    if (isNaN(precio)) return alert("Precio inv√°lido");

    try {
      const res = await fetch(`${BASE}/cotizador/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, unidad, precio })
      });

      if (!res.ok) return alert("Error al actualizar el material");

      tr.querySelector('.td-nombre').textContent = nombre;
      tr.querySelector('.td-unidad').textContent = unidad;
      tr.querySelector('.td-precio').textContent = formatPrice(precio);

      tr.querySelector('[data-action="editar"]').style.display = 'inline-block';
      tr.querySelector('[data-action="guardar"]').style.display = 'none';
      tr.querySelector('[data-action="cancelar"]').style.display = 'none';

      alert("Material actualizado correctamente");

    } catch (e) {
      alert("No se pudo conectar con el servidor");
    }
  }

  document.getElementById('searchInput').addEventListener('input', e => {
    const term = e.target.value.toLowerCase().trim();
    if (!term) return renderMateriales(materialesData);

    const filtrados = materialesData.filter(m =>
      String(getField(m,'IDmaterial')).toLowerCase().includes(term) ||
      String(getField(m,'Unidad')).toLowerCase().includes(term)
    );
    renderMateriales(filtrados);
  });

  document.getElementById('clearSearch').onclick = () => {
    document.getElementById('searchInput').value = '';
    renderMateriales(materialesData);
  };

  document.addEventListener('DOMContentLoaded', cargarMateriales);

</script>
</body>
</html>
